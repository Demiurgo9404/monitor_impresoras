<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <!-- Headers de Seguridad OWASP -->
    <httpProtocol>
      <customHeaders>
        <add name="X-Content-Type-Options" value="nosniff" />
        <add name="X-Frame-Options" value="DENY" />
        <add name="X-XSS-Protection" value="1; mode=block" />
        <add name="Referrer-Policy" value="no-referrer" />
        <add name="Permissions-Policy" value="geolocation=(), microphone=(), camera=()" />
        <remove name="X-Powered-By" />
      </customHeaders>
    </httpProtocol>

    <!-- Compresión HTTP dinámica y estática -->
    <urlCompression doDynamicCompression="true" doStaticCompression="true" dynamicCompressionBeforeCache="true" />
    <httpCompression>
      <dynamicTypes>
        <add mimeType="text/*" enabled="true" />
        <add mimeType="message/*" enabled="true" />
        <add mimeType="application/javascript" enabled="true" />
        <add mimeType="application/json" enabled="true" />
        <add mimeType="*/*" enabled="false" />
      </dynamicTypes>
      <staticTypes>
        <add mimeType="text/*" enabled="true" />
        <add mimeType="message/*" enabled="true" />
        <add mimeType="application/javascript" enabled="true" />
        <add mimeType="application/json" enabled="true" />
        <add mimeType="application/atom+xml" enabled="true" />
        <add mimeType="application/rss+xml" enabled="true" />
      </staticTypes>
    </httpCompression>

    <!-- Límites de seguridad -->
    <security>
      <requestFiltering>
        <!-- Límite de tamaño de request -->
        <requestLimits maxAllowedContentLength="10485760" />

        <!-- Límites de archivos -->
        <fileExtensions allowUnlisted="true">
          <!-- Permitir solo tipos seguros -->
          <add fileExtension=".json" allowed="true" />
          <add fileExtension=".xml" allowed="true" />
        </fileExtensions>

        <!-- Límites de URL y query string -->
        <requestLimits maxUrl="4096" maxQueryString="2048" />
      </requestFiltering>
    </security>

    <!-- Configuración de protocolos seguros -->
    <httpProtocol>
      <redirectHeaders>
        <add name="Strict-Transport-Security" value="max-age=31536000; includeSubDomains; preload" />
      </redirectHeaders>
    </httpProtocol>

    <!-- Configuración de módulos -->
    <modules>
      <!-- Remover módulos innecesarios para seguridad -->
      <remove name="DirectoryListingModule" />
      <remove name="IsapiModule" />
    </modules>

    <!-- Configuración de errores personalizados -->
    <httpErrors errorMode="DetailedLocalOnly">
      <remove statusCode="404" subStatusCode="-1" />
      <remove statusCode="500" subStatusCode="-1" />
      <error statusCode="404" prefixLanguageFilePath="" path="/errors/404.html" responseMode="ExecuteURL" />
      <error statusCode="500" prefixLanguageFilePath="" path="/errors/500.html" responseMode="ExecuteURL" />
    </httpErrors>

    <!-- Configuración de logging detallado -->
    <httpLogging logOnlyFirstRequest="false" logRequestsOnly="false" logErrorsOnly="false" logDetailedErrors="true" />

    <!-- Configuración de aplicación pool -->
    <applicationInitialization>
      <add initializationPage="/" />
    </applicationInitialization>
  </system.webServer>

  <!-- Configuración de aplicación -->
  <appSettings>
    <!-- Configuración de entorno -->
    <add key="ASPNETCORE_ENVIRONMENT" value="Production" />
    <add key="ASPNETCORE_URLS" value="http://localhost:5000" />
    <add key="ASPNETCORE_HTTPS_PORT" value="5001" />

    <!-- Configuración de seguridad adicional -->
    <add key="SecurityHeaders:X-Content-Type-Options" value="nosniff" />
    <add key="SecurityHeaders:X-Frame-Options" value="DENY" />
    <add key="SecurityHeaders:Referrer-Policy" value="no-referrer" />
  </appSettings>

  <!-- Configuración de conexión segura -->
  <connectionStrings>
    <add name="DefaultConnection" connectionString="Server=.;Database=MonitorImpresoras;Trusted_Connection=True;MultipleActiveResultSets=true;Encrypt=True;TrustServerCertificate=True;" providerName="System.Data.SqlClient" />
  </connectionStrings>
</configuration>
