@inject AuthService AuthService
@inject TenantService TenantService
@implements IDisposable

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">
            <i class="fas fa-print text-primary"></i>
            <strong>QOPIQ</strong>
        </a>
        <button title="Alternar navegación" class="navbar-toggler" @onclick="ToggleNavMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
    </div>
</div>

<div class="@NavMenuCssClass nav-scrollable" @onclick="CollapseNavMenu">
    <nav class="flex-column">
        <AuthorizeView>
            <Authorized>
                <!-- Información del Tenant -->
                @if (currentCompany != null)
                {
                    <div class="nav-item px-3 py-2 border-bottom">
                        <small class="text-muted">Empresa Actual</small>
                        <div class="fw-bold text-primary">@currentCompany.Name</div>
                    </div>
                }

                <!-- Dashboard -->
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="/" Match="NavLinkMatch.All">
                        <span class="oi oi-home" aria-hidden="true"></span> Dashboard
                    </NavLink>
                </div>

                <!-- Reportes -->
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="/reports">
                        <span class="oi oi-document" aria-hidden="true"></span> Reportes
                    </NavLink>
                </div>

                <!-- Reportes Programados -->
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="/scheduled-reports">
                        <span class="oi oi-calendar" aria-hidden="true"></span> Calendario
                    </NavLink>
                </div>

                <!-- Templates -->
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="/templates">
                        <span class="oi oi-grid-three-up" aria-hidden="true"></span> Templates
                    </NavLink>
                </div>

                <!-- Proyectos (Solo Admin y ProjectManager) -->
                <AuthorizeView Roles="SuperAdmin,CompanyAdmin,ProjectManager">
                    <div class="nav-item px-3">
                        <NavLink class="nav-link" href="/projects">
                            <span class="oi oi-briefcase" aria-hidden="true"></span> Proyectos
                        </NavLink>
                    </div>
                </AuthorizeView>

                <!-- Impresoras -->
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="/printers">
                        <span class="oi oi-print" aria-hidden="true"></span> Impresoras
                    </NavLink>
                </div>

                <!-- Administración (Solo SuperAdmin) -->
                <AuthorizeView Roles="SuperAdmin">
                    <div class="nav-item px-3">
                        <div class="nav-link text-muted">
                            <small>ADMINISTRACIÓN</small>
                        </div>
                    </div>
                    <div class="nav-item px-3">
                        <NavLink class="nav-link" href="/admin/companies">
                            <span class="oi oi-building" aria-hidden="true"></span> Empresas
                        </NavLink>
                    </div>
                    <div class="nav-item px-3">
                        <NavLink class="nav-link" href="/admin/users">
                            <span class="oi oi-people" aria-hidden="true"></span> Usuarios
                        </NavLink>
                    </div>
                </AuthorizeView>

                <!-- Estadísticas -->
                <div class="nav-item px-3 mt-3">
                    <div class="nav-link text-muted">
                        <small>ESTADÍSTICAS</small>
                    </div>
                </div>
                @if (stats != null)
                {
                    <div class="nav-item px-3">
                        <div class="small text-muted">
                            <div class="d-flex justify-content-between">
                                <span>Reportes:</span>
                                <span class="badge bg-primary">@stats.TotalReports</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Impresoras:</span>
                                <span class="badge bg-success">@stats.ActivePrinters</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Proyectos:</span>
                                <span class="badge bg-info">@stats.ActiveProjects</span>
                            </div>
                        </div>
                    </div>
                }
            </Authorized>
        </AuthorizeView>
    </nav>
</div>

@code {
    private bool collapseNavMenu = true;
    private CompanyInfo? currentCompany;
    private DashboardStats? stats;

    private string? NavMenuCssClass => collapseNavMenu ? "collapse" : null;

    protected override async Task OnInitializedAsync()
    {
        await LoadCompanyInfo();
        await LoadStats();
    }

    private async Task LoadCompanyInfo()
    {
        try
        {
            currentCompany = await TenantService.GetCurrentCompanyInfoAsync();
        }
        catch
        {
            // Manejar error silenciosamente
        }
    }

    private async Task LoadStats()
    {
        try
        {
            stats = await TenantService.GetTenantStatsAsync();
        }
        catch
        {
            // Manejar error silenciosamente
        }
    }

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
    }

    private void CollapseNavMenu()
    {
        collapseNavMenu = true;
    }

    public void Dispose()
    {
        // Cleanup si es necesario
    }
}
